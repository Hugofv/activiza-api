generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// Alteração: Operation.id, Installment.id e Payment.id -> BigInt
// Todas as FKs que referenciam essas chaves também foram ajustadas para BigInt.
// Campos permanecem em camelCase com @map para snake_case no DB.

model PlatformUser {
  id                   Int       @id @default(autoincrement())
  name                 String
  email                String    @unique
  phone                String?
  document             String?   @unique
  meta                 Json?
  passwordHash         String?   @map("password_hash")
  role                 String    @default("agent")
  twoFa                Boolean   @default(false) @map("two_fa")
  isActive             Boolean   @default(true) @map("is_active")
  emailVerifiedAt      DateTime? @map("email_verified_at")
  lastLoginAt          DateTime? @map("last_login_at")
  passwordResetToken   String?   @map("password_reset_token")
  passwordResetExpires DateTime? @map("password_reset_expires")
  deletedAt            DateTime? @map("deleted_at")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  accounts         Account[]      @relation("AccountOwner")
  notificationUser Notification[] @relation("NotificationUser")

  @@index([email], name: "idx_platform_user_email")
  @@index([role], name: "idx_platform_user_role")
  @@index([isActive], name: "idx_platform_user_is_active")
  @@index([deletedAt], name: "idx_platform_user_deleted_at")
  @@index([role, deletedAt], name: "idx_platform_user_role_deleted")
  @@index([createdAt], name: "idx_platform_user_created_at")
  @@map("platform_users")
}

model Account {
  id        Int       @id @default(autoincrement())
  name      String
  phone     String?
  email     String
  document  String?
  status    String    @default("ACTIVE")
  currency  String    @default("BRL")
  planId    Int?      @map("plan_id")
  meta      Json?
  ownerId   Int?      @map("owner_id")
  createdBy String?   @map("created_by") // e.g. "{id}-{email}"
  updatedBy String?   @map("updated_by")
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  owner          PlatformUser?       @relation("AccountOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  plan           Plan?               @relation(fields: [planId], references: [id], onDelete: SetNull)
  address        Address?
  clients        Client[]
  operations     Operation[]
  settings       Setting[]
  resources      Resource[]
  qualifications LeadQualification[]
  featureUsages  FeatureUsage[]

  @@index([email], name: "idx_account_email")
  @@index([ownerId], name: "idx_account_owner_id")
  @@index([planId], name: "idx_account_plan_id")
  @@index([status], name: "idx_account_status")
  @@index([deletedAt], name: "idx_account_deleted_at")
  @@index([ownerId, deletedAt], name: "idx_account_owner_deleted")
  @@index([createdAt], name: "idx_account_created_at")
  @@map("accounts")
}

model Address {
  id           Int       @id @default(autoincrement())
  street       String?
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?
  country      String?   @default("BR")
  zip          String?
  accountId    Int?      @unique @map("account_id")
  clientId     Int?      @unique @map("client_id")
  resourceId   Int?      @unique @map("resource_id")
  createdBy    String?   @map("created_by")
  updatedBy    String?   @map("updated_by")
  deletedAt    DateTime? @map("deleted_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  account  Account?  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  client   Client?   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  resource Resource? @relation("ResourceAddress")

  @@map("addresses")
}

model Client {
  id                  Int       @id @default(autoincrement())
  document            String? // CPF or CNPJ - optional for onboarding
  documentType        String?   @map("document_type") // 'cpf', 'cnpj', 'ssn', 'ein', 'ni', 'crn', 'other'
  documentCountryCode String?   @map("document_country_code") // 'BR', 'US', 'UK', etc.
  accountId           Int?      @map("account_id") // Optional during onboarding
  name                String? // Optional during onboarding
  phone               String?
  email               String    @unique // Obrigatório, identificador primário durante onboarding
  meta                Json?
  createdBy           String?   @map("created_by")
  updatedBy           String?   @map("updated_by")
  deletedAt           DateTime? @map("deleted_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  account        Account?            @relation(fields: [accountId], references: [id], onDelete: Cascade)
  address        Address?
  operations     Operation[]
  payments       Payment[]
  photos         ClientPhoto[]
  qualifications LeadQualification[]

  @@index([email], name: "idx_client_email")
  @@index([accountId], name: "idx_client_account_id")
  @@index([deletedAt], name: "idx_client_deleted_at")
  @@index([accountId, deletedAt], name: "idx_client_account_deleted")
  @@index([createdAt], name: "idx_client_created_at")
  @@index([documentCountryCode, document], name: "idx_document_by_country")
  @@map("clients")
}

model ClientPhoto {
  id        Int       @id @default(autoincrement())
  clientId  Int       @map("client_id")
  url       String
  meta      Json?
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId], name: "idx_client_photo_client_id")
  @@index([deletedAt], name: "idx_client_photo_deleted_at")
  @@map("client_photos")
}

// ------------ OPERATION (id -> BigInt) ------------
model Operation {
  id              BigInt    @id @default(autoincrement()) @db.BigInt
  accountId       Int       @map("account_id")
  clientId        Int       @map("client_id")
  type            String
  title           String?
  description     String?
  principalAmount Decimal   @map("principal_amount")
  currency        String    @default("BRL")
  startDate       DateTime  @map("start_date")
  dueDate         DateTime? @map("due_date")
  frequency       String?
  interestRate    Decimal?  @map("interest_rate")
  entryAmount     Decimal?  @map("entry_amount")
  installments    Int?
  depositAmount   Decimal?  @map("deposit_amount")
  collateralMeta  Json?     @map("collateral_meta")
  meta            Json?
  status          String?
  resourceId      Int?      @map("resource_id")
  createdBy       String?   @map("created_by")
  updatedBy       String?   @map("updated_by")
  deletedAt       DateTime? @map("deleted_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  account          Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)
  client           Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  installmentsList Installment[]    @relation("OperationInstallments")
  photos           OperationPhoto[]
  resource         Resource?        @relation(fields: [resourceId], references: [id])
  alerts           Alert[]
  payments         Payment[]
  featureUsages    FeatureUsage[]

  @@index([accountId], name: "idx_operation_account_id")
  @@index([clientId], name: "idx_operation_client_id")
  @@index([status], name: "idx_operation_status")
  @@index([type], name: "idx_operation_type")
  @@index([deletedAt], name: "idx_operation_deleted_at")
  @@index([accountId, deletedAt], name: "idx_operation_account_deleted")
  @@index([clientId, deletedAt], name: "idx_operation_client_deleted")
  @@index([status, deletedAt], name: "idx_operation_status_deleted")
  @@index([createdAt], name: "idx_operation_created_at")
  @@index([dueDate], name: "idx_operation_due_date")
  @@map("operations")
}

// OperationPhoto references operation.id (BigInt)
model OperationPhoto {
  id          Int       @id @default(autoincrement())
  operationId BigInt    @map("operation_id") @db.BigInt
  url         String
  meta        Json?
  createdBy   String?   @map("created_by")
  updatedBy   String?   @map("updated_by")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  operation Operation @relation(fields: [operationId], references: [id], onDelete: Cascade)

  @@map("operation_photos")
}

// ------------ INSTALLMENT (id -> BigInt) ------------
model Installment {
  id             BigInt    @id @default(autoincrement()) @db.BigInt
  operationId    BigInt    @map("operation_id") @db.BigInt
  dueDate        DateTime  @map("due_date")
  amount         Decimal
  principal      Decimal?
  interest       Decimal?
  status         String    @default("PENDING")
  paidAt         DateTime? @map("paid_at")
  lateFeePercent Decimal?  @map("late_fee_percent")
  notes          String?
  createdBy      String?   @map("created_by")
  updatedBy      String?   @map("updated_by")
  deletedAt      DateTime? @map("deleted_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  operation Operation @relation("OperationInstallments", fields: [operationId], references: [id], onDelete: Cascade)
  payments  Payment[]

  @@index([operationId], name: "idx_installment_operation_id")
  @@index([status], name: "idx_installment_status")
  @@index([dueDate], name: "idx_installment_due_date")
  @@index([deletedAt], name: "idx_installment_deleted_at")
  @@index([operationId, status], name: "idx_installment_operation_status")
  @@index([operationId, deletedAt], name: "idx_installment_operation_deleted")
  @@index([status, dueDate], name: "idx_installment_status_due_date")
  @@map("installments")
}

// ------------ PAYMENT (id -> BigInt) ------------
model Payment {
  id            BigInt    @id @default(autoincrement()) @db.BigInt
  clientId      Int       @map("client_id")
  installmentId BigInt?   @map("installment_id") @db.BigInt
  operationId   BigInt    @map("operation_id") @db.BigInt
  amount        Decimal
  currency      String    @default("BRL")
  paidAt        DateTime  @default(now()) @map("paid_at")
  method        String?
  reference     String?
  meta          Json?
  createdBy     String?   @map("created_by")
  updatedBy     String?   @map("updated_by")
  deletedAt     DateTime? @map("deleted_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  client      Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  installment Installment? @relation(fields: [installmentId], references: [id], onDelete: SetNull)
  operation   Operation    @relation(fields: [operationId], references: [id], onDelete: Cascade)

  @@index([clientId], name: "idx_payment_client_id")
  @@index([operationId], name: "idx_payment_operation_id")
  @@index([installmentId], name: "idx_payment_installment_id")
  @@index([deletedAt], name: "idx_payment_deleted_at")
  @@index([paidAt], name: "idx_payment_paid_at")
  @@index([operationId, deletedAt], name: "idx_payment_operation_deleted")
  @@map("payments")
}

model Resource {
  id          Int       @id @default(autoincrement())
  accountId   Int       @map("account_id")
  type        String
  title       String
  description String?
  addressId   Int?      @unique @map("address_id")
  photos      Json?
  meta        Json?
  createdBy   String?   @map("created_by")
  updatedBy   String?   @map("updated_by")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  account    Account     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  address    Address?    @relation("ResourceAddress", fields: [addressId], references: [id], onDelete: SetNull)
  operations Operation[]

  @@index([accountId], name: "idx_resource_account_id")
  @@index([type], name: "idx_resource_type")
  @@index([deletedAt], name: "idx_resource_deleted_at")
  @@index([accountId, deletedAt], name: "idx_resource_account_deleted")
  @@map("resources")
}

model Alert {
  id          Int       @id @default(autoincrement())
  operationId BigInt    @map("operation_id") @db.BigInt
  type        String
  sendAt      DateTime? @map("send_at")
  template    String?
  enabled     Boolean   @default(true)
  meta        Json?
  createdBy   String?   @map("created_by")
  updatedBy   String?   @map("updated_by")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  operation Operation @relation(fields: [operationId], references: [id], onDelete: Cascade)

  @@index([operationId], name: "idx_alert_operation_id")
  @@index([type], name: "idx_alert_type")
  @@index([enabled], name: "idx_alert_enabled")
  @@index([sendAt], name: "idx_alert_send_at")
  @@index([deletedAt], name: "idx_alert_deleted_at")
  @@index([operationId, deletedAt], name: "idx_alert_operation_deleted")
  @@map("alerts")
}

model Notification {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  title     String
  body      String
  channel   String?
  sentAt    DateTime? @map("sent_at")
  read      Boolean   @default(false)
  meta      Json?
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  user PlatformUser @relation("NotificationUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], name: "idx_notification_user_id")
  @@index([read], name: "idx_notification_read")
  @@index([deletedAt], name: "idx_notification_deleted_at")
  @@index([userId, read], name: "idx_notification_user_read")
  @@index([userId, deletedAt], name: "idx_notification_user_deleted")
  @@index([createdAt], name: "idx_notification_created_at")
  @@map("notifications")
}

model Setting {
  id        Int       @id @default(autoincrement())
  accountId Int?      @map("account_id")
  key       String
  value     Json?
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  account Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, key])
  @@map("settings")
}

model AuditLog {
  id        Int       @id @default(autoincrement())
  actor     String?   @map("actor") // e.g. \"{id}-{email}\" at log time, no FK to keep trail even if user changes
  action    String
  entity    String?
  entityId  String?   @map("entity_id")
  before    Json?
  after     Json?
  ip        String?
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@map("audit_logs")
}

// ------------ PLANS & FEATURES ------------
model Plan {
  id            Int     @id @default(autoincrement())
  name          String
  description   String?
  billingPeriod String  @default("MONTHLY") // MONTHLY, YEARLY
  isActive      Boolean @default(true) @map("is_active")
  isPublic      Boolean @default(true) @map("is_public") // Show in public plans
  sortOrder     Int     @default(0) @map("sort_order")

  // Limitations
  maxOperations Int? @map("max_operations") // null = unlimited
  maxClients    Int? @map("max_clients")
  maxUsers      Int? @map("max_users")
  maxStorage    Int? @map("max_storage") // in MB, null = unlimited

  // Note: Plan price is calculated from sum of enabled feature prices per currency

  meta      Json?
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  features PlanFeature[]
  accounts Account[]

  @@index([isActive], name: "idx_plan_is_active")
  @@index([isPublic], name: "idx_plan_is_public")
  @@index([deletedAt], name: "idx_plan_deleted_at")
  @@index([isActive, isPublic, deletedAt], name: "idx_plan_active_public_deleted")
  @@index([sortOrder], name: "idx_plan_sort_order")
  @@map("plans")
}

model Feature {
  id          Int       @id @default(autoincrement())
  key         String    @unique // e.g., "advanced_reports", "api_access"
  name        String
  description String?
  category    String? // e.g., "reports", "integrations", "automation"
  moduleId    Int?      @map("module_id")
  isActive    Boolean   @default(true) @map("is_active")
  sortOrder   Int       @default(0) @map("sort_order")
  meta        Json?
  createdBy   String?   @map("created_by")
  updatedBy   String?   @map("updated_by")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  module Module?       @relation(fields: [moduleId], references: [id], onDelete: SetNull)
  plans  PlanFeature[]

  @@map("features")
}

// ------------ MODULES ------------
model Module {
  id          Int       @id @default(autoincrement())
  key         String    @unique // e.g., "loan", "rent_room", "rent_house", "rent_vehicle"
  name        String
  description String?
  category    String? // e.g., "real_estate", "lending"
  isActive    Boolean   @default(true) @map("is_active")
  sortOrder   Int       @default(0) @map("sort_order")
  meta        Json?
  createdBy   String?   @map("created_by")
  updatedBy   String?   @map("updated_by")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  features Feature[]

  @@map("modules")
}

model PlanFeature {
  id             Int      @id @default(autoincrement())
  planId         Int      @map("plan_id")
  featureId      Int      @map("feature_id")
  isEnabled      Boolean  @default(true) @map("is_enabled")
  operationLimit Int?     @map("operation_limit") // Max operations allowed for this feature in this plan (null = unlimited)
  resetPeriod    String   @default("LIFETIME") @map("reset_period") // MONTHLY, YEARLY, LIFETIME
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  plan    Plan               @relation(fields: [planId], references: [id], onDelete: Cascade)
  feature Feature            @relation(fields: [featureId], references: [id], onDelete: Cascade)
  prices  PlanFeaturePrice[] // Multiple prices for different currencies
  usages  FeatureUsage[]

  @@unique([planId, featureId])
  @@map("plan_features")
}

// ------------ PLAN FEATURE PRICING (Multi-currency) ------------
model PlanFeaturePrice {
  id            Int      @id @default(autoincrement())
  planFeatureId Int      @map("plan_feature_id")
  currency      String // e.g., "BRL", "USD", "EUR"
  price         Decimal  @db.Decimal(10, 2) // Price in this currency
  isDefault     Boolean  @default(false) @map("is_default") // Default price for this currency
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  planFeature PlanFeature @relation(fields: [planFeatureId], references: [id], onDelete: Cascade)

  @@unique([planFeatureId, currency])
  @@map("plan_feature_prices")
}

// ------------ FEATURE USAGE TRACKING ------------
model FeatureUsage {
  id            Int      @id @default(autoincrement())
  accountId     Int      @map("account_id")
  planFeatureId Int      @map("plan_feature_id")
  operationId   BigInt   @map("operation_id") @db.BigInt
  usageDate     DateTime @default(now()) @map("usage_date")
  period        String   @map("period") // e.g., "2024-01" for monthly tracking
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  account     Account     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  planFeature PlanFeature @relation(fields: [planFeatureId], references: [id], onDelete: Cascade)
  operation   Operation   @relation(fields: [operationId], references: [id], onDelete: Cascade)

  @@index([accountId, planFeatureId, period])
  @@map("feature_usages")
}

// ------------ LEAD QUALIFICATION ------------
model LeadQualification {
  id          Int       @id @default(autoincrement())
  accountId   Int?      @map("account_id") // null = template question
  clientId    Int?      @map("client_id") // For client-specific qualifications
  questionKey String    @map("question_key") // e.g., "business_type", "monthly_operations"
  question    String
  answer      Json? // Can be string, number, array, object
  score       Int? // Qualification score (0-100)
  metadata    Json? // Additional data
  createdBy   String?   @map("created_by")
  updatedBy   String?   @map("updated_by")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  account Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)
  client  Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([accountId], name: "idx_lead_qualification_account_id")
  @@index([clientId], name: "idx_lead_qualification_client_id")
  @@index([questionKey], name: "idx_lead_qualification_question_key")
  @@index([deletedAt], name: "idx_lead_qualification_deleted_at")
  @@index([accountId, questionKey], name: "idx_lead_qualification_account_question")
  @@index([clientId, questionKey], name: "idx_lead_qualification_client_question")
  @@index([clientId, deletedAt], name: "idx_lead_qualification_client_deleted")
  @@map("lead_qualifications")
}
